{% extends "base.html" %}

{% block title %}Download Statistics - YouTube Downloader{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-10 text-center">
            <div class="mb-4">
                <i data-feather="bar-chart-2" style="width: 64px; height: 64px; color: #667eea;"></i>
            </div>
            <h1 class="display-5 fw-bold mb-3">Download Statistics</h1>
            <p class="lead text-muted">Track downloads, popular videos, and usage analytics</p>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="stats-loading" class="row justify-content-center">
        <div class="col-auto">
            <div class="d-flex align-items-center">
                <div class="spinner-border spinner-border-sm me-2" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <span>Loading statistics...</span>
            </div>
        </div>
    </div>

    <!-- Statistics Content -->
    <div id="stats-content" class="d-none">
        <!-- Overview Cards -->
        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="card h-100 text-center">
                    <div class="card-body">
                        <i data-feather="download" class="mb-3" style="color: #4facfe; width: 40px; height: 40px;"></i>
                        <h3 id="total-downloads" class="display-6 fw-bold mb-2">0</h3>
                        <p class="text-muted mb-0">Total Downloads</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 text-center">
                    <div class="card-body">
                        <i data-feather="video" class="mb-3" style="color: #f5576c; width: 40px; height: 40px;"></i>
                        <h3 id="video-downloads" class="display-6 fw-bold mb-2">0</h3>
                        <p class="text-muted mb-0">Video Downloads</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 text-center">
                    <div class="card-body">
                        <i data-feather="headphones" class="mb-3" style="color: #00f2fe; width: 40px; height: 40px;"></i>
                        <h3 id="audio-downloads" class="display-6 fw-bold mb-2">0</h3>
                        <p class="text-muted mb-0">Audio Downloads</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Popular Videos -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i data-feather="trending-up" class="me-2"></i>
                            Most Popular Videos
                        </h5>
                        <div id="popular-videos" class="row g-3">
                            <!-- Popular videos will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Downloads -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i data-feather="clock" class="me-2"></i>
                            Recent Downloads
                        </h5>
                        <div id="recent-downloads" class="list-group list-group-flush">
                            <!-- Recent downloads will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Daily Stats Chart -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i data-feather="activity" class="me-2"></i>
                            Daily Download Activity
                        </h5>
                        <div id="daily-stats" class="row g-3">
                            <!-- Daily stats will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Back -->
    <div class="row justify-content-center mt-5">
        <div class="col-auto">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i data-feather="arrow-left" class="me-2"></i>
                Back to Downloader
            </a>
        </div>
    </div>
</div>

<!-- Custom JavaScript for Stats -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
});

async function loadStatistics() {
    try {
        const response = await fetch('/api/stats');
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.error || 'Failed to load statistics');
        }
        
        // Update overview cards
        document.getElementById('total-downloads').textContent = data.total_downloads.toLocaleString();
        document.getElementById('video-downloads').textContent = data.total_video_downloads.toLocaleString();
        document.getElementById('audio-downloads').textContent = data.total_audio_downloads.toLocaleString();
        
        // Populate popular videos
        const popularVideosContainer = document.getElementById('popular-videos');
        popularVideosContainer.innerHTML = '';
        
        if (data.popular_videos.length === 0) {
            popularVideosContainer.innerHTML = '<div class="col-12"><p class="text-muted text-center">No downloads yet</p></div>';
        } else {
            data.popular_videos.forEach((video, index) => {
                const videoCard = document.createElement('div');
                videoCard.className = 'col-md-6 col-lg-4';
                videoCard.innerHTML = `
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex align-items-start">
                                <img src="${video.thumbnail_url}" alt="Thumbnail" 
                                     class="rounded me-3" style="width: 60px; height: 45px; object-fit: cover;">
                                <div class="flex-grow-1">
                                    <h6 class="card-title mb-1" style="font-size: 0.9rem; line-height: 1.3;">
                                        ${video.title.length > 50 ? video.title.substring(0, 50) + '...' : video.title}
                                    </h6>
                                    <p class="text-muted mb-1" style="font-size: 0.8rem;">${video.author}</p>
                                    <span class="badge bg-success">${video.download_count} downloads</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                popularVideosContainer.appendChild(videoCard);
            });
        }
        
        // Populate recent downloads
        const recentDownloadsContainer = document.getElementById('recent-downloads');
        recentDownloadsContainer.innerHTML = '';
        
        if (data.recent_downloads.length === 0) {
            recentDownloadsContainer.innerHTML = '<div class="list-group-item text-center text-muted">No recent downloads</div>';
        } else {
            data.recent_downloads.forEach(download => {
                const downloadItem = document.createElement('div');
                downloadItem.className = 'list-group-item list-group-item-action';
                
                const completedDate = download.completed_at ? 
                    new Date(download.completed_at).toLocaleDateString() + ' ' + 
                    new Date(download.completed_at).toLocaleTimeString() : 'Unknown';
                
                downloadItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${download.title.length > 60 ? download.title.substring(0, 60) + '...' : download.title}</h6>
                            <p class="mb-1 text-muted">${download.author}</p>
                        </div>
                        <div class="text-end">
                            <span class="badge ${download.download_type === 'video' ? 'bg-primary' : 'bg-secondary'}">${download.quality}</span>
                            <small class="text-muted d-block">${completedDate}</small>
                        </div>
                    </div>
                `;
                recentDownloadsContainer.appendChild(downloadItem);
            });
        }
        
        // Populate daily stats
        const dailyStatsContainer = document.getElementById('daily-stats');
        dailyStatsContainer.innerHTML = '';
        
        if (data.daily_stats.length === 0) {
            dailyStatsContainer.innerHTML = '<div class="col-12"><p class="text-muted text-center">No daily statistics available</p></div>';
        } else {
            data.daily_stats.reverse().forEach(stat => {
                const statCard = document.createElement('div');
                statCard.className = 'col-md-6 col-lg-3';
                statCard.innerHTML = `
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">${new Date(stat.date).toLocaleDateString()}</h5>
                            <p class="mb-1"><strong>${stat.total_downloads}</strong> downloads</p>
                            <small class="text-muted">
                                ${stat.video_downloads} video, ${stat.audio_downloads} audio
                            </small>
                        </div>
                    </div>
                `;
                dailyStatsContainer.appendChild(statCard);
            });
        }
        
        // Show content and hide loading
        document.getElementById('stats-loading').classList.add('d-none');
        document.getElementById('stats-content').classList.remove('d-none');
        document.getElementById('stats-content').classList.add('fade-in');
        
        // Initialize feather icons
        feather.replace();
        
    } catch (error) {
        console.error('Error loading statistics:', error);
        document.getElementById('stats-loading').innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger text-center" role="alert">
                    <i data-feather="alert-circle" class="me-2"></i>
                    Error loading statistics: ${error.message}
                </div>
            </div>
        `;
        feather.replace();
    }
}
</script>
{% endblock %}